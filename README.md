# Популярность товара и сортировка по нему

##Задача
Необходимо реализовать следующий функционал:                    
Подсчет популярных товаров. Популярность = V + 3*B + 10*P - U.                     
Подсчет должен логироваться в отдельной таблице или hl-блоке чтобы можно было проанализировать подсчет популярности.                    
Примечание: кол-во просмотров товара - предусмотреть защиту от накручивания, так чтобы при одной сессии проход не считался более одного раза.                    
                    
V -  кол-во просмотров товара (проходов в деталку и просмотр более 5 секунд включительно) за последние полгода;                    
B - кол-во купленных и оплаченных товаров за последний год. **В текущей реализации учитывается возможность наличия торговых предложений товара.**                    
P - равно единице если количество картинок товара больше одной и нулю если нет;                    
U - негативное кол-во просмотров товара (проходов в деталку и просмотр менее 5 секунд) за последние полгода.                    
На странице вывода товаров доработать сортировку по популярности (создать компонент для размещения в списке товаров).                     

##Подготовка
Для выполнения задачи использовалась редакция "Бизнес", со стандартным решением "Интернет-Магазин". Развернуто все было на локальном ПК с помощью OpenServer. Конфигурация сервера: 
- модуль Apache-PHP-7, 
- модуль PHP-7.1, 
- модуль MySQL-5.6

##Алгоритм
Поскольку в задаче есть разница между негативными и позитивными просмотрами, было решено отказаться от стандартного поля SHOW_COUNTER                    
Был создан вспомогательный инфоблок "Показы", количество элементов которого меньше, либо равно количеству товаров на сайте..                    
Свойства инфоблока:                     
- ID товара (Связка с товаром каталога)
- Показы (общее количество "полезных" показов товара. Множественное войство с описанием. В значении хранится дата, в описании - количество просмотров)
- Негативные показы (общее количество "негативных" показов товара. Множественное свойство с описанием. В значении хранится дата, в описании - количество просмотров)
- Показы за сутки (количество "полезных" показов за сутки)
- Негативные показы за сутки (количество "негативных" показов за сутки)
                    
                                        
При заходе в карточку товара инициализируется ajax-запрос в файл /local/ajax/showsController.php с флагом "негативный просмотр"                    
Спустя 5 секунд инициализируется повторный запрос с флагом "позитивный просмотр".                    
Если c ID текущего товара записи в инфоблоке "Показы" еще не создано, то создается запись с 1 негативным просмотром.                    
При запросе с флагом "негативный" проверяется сессия пользователя дя текущего товара, затем счетчик негативных просмотров увеличивается на 1. Пользователь за время сессии не может создать больше одного негативного просмотра для товара                    
При запросе с флагом "позитивный" проверяется сессия пользователя дя текущего товара, затем счетчик негативных просмотров уменьшается на 1, а счетчик позитивных просмотров увеличивается на 1. Пользователь за время сессии не может создать больше одного позитивного просмотра для товара. В случае, если у пользователя был негативный просмотр товара, в будущем, зайдя в карточку более, чем на 5 секунд, его просмотр изменится на позитивный.               

Дополнительные свойства инфоблока "товары"
- Показы за полгода (Количество "полезных" показов товара за последние полгода)
- Негативные показы за полгода (Количество "негативных" показов за полгода)
- Популярность (числовой показатель популярности товара)

Функция-агент (в идеале необходимо паставить на крон) SetShowsToProd() ежедневно обновляет свойства "Показы" и "Негативные показы" для каждого элемента, а так же обновляет свойства "Показы за полгода" и "Негативные показы за полгода" для связанных элементов инфоблока с товарами                    
Функция-агент (в идеале необходимо поставить на крон) countPopularity() ежедневно обновляет свойство "Популярность" для каждого элемента инфоблока с товарами

##Список директорий и файлов
- /local/ajax/showsController.php - контроллер просмотров товаров, обрабатывает "позитивные" и "негативные" просмотры
- /local/php_interface/include/agents/SetShowsToProd.php - содержит описание функции SetShowsToProd();
- /local/php_interface/include/agents/countPopularity.php - содержит описание функции countPopularity();
- /local/components/yar/popular.sort/ - директория содержит компонент, выводящий на страницу каталога чекбокс сортировки по популярности

##Логирование
Логирование вычисления популярности происходит в функции countPopularity(): для каждого товара записываются промежуточные значения из формулы V + 3*B + 10*P - U. Так же записывается дата обновления популярности. Результаты записываются в HL-инфоблок "Логирование вычисления популярности"